// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Efloud Price Action Trading System v4.0 - TREND FOLLOWING EDITION
// Designed to beat Buy & Hold with aggressive trend following

//@version=6
strategy("EPA Strategy v4 Trend", shorttitle="EPA-v4", overlay=true,
         default_qty_type=strategy.percent_of_equity, default_qty_value=100,
         initial_capital=10000, commission_type=strategy.commission.percent,
         commission_value=0.1, slippage=2, pyramiding=3, calc_on_every_tick=false,
         process_orders_on_close=true)

// ═══════════════════════════════════════════════════════════════════════════
//                              STRATEGY INPUTS
// ═══════════════════════════════════════════════════════════════════════════

grpStrategy = "═══ Position Management ═══"
positionSize = input.float(30, "Position Size (%)", minval=10, maxval=100, step=10, group=grpStrategy, tooltip="Percentage of equity per position")
maxPyramiding = input.int(3, "Max Pyramid Entries", minval=1, maxval=5, group=grpStrategy)
pyramidThreshold = input.float(3.0, "Pyramid After (% profit)", minval=1.0, maxval=10.0, step=0.5, group=grpStrategy)

grpRisk = "═══ Risk Management ═══"
useStopLoss = input.bool(true, "Use Stop Loss", group=grpRisk)
stopLossPercent = input.float(5.0, "Stop Loss (%)", minval=2.0, maxval=15.0, step=0.5, group=grpRisk)
useTakeProfit = input.bool(false, "Use Take Profit", group=grpRisk)
takeProfitPercent = input.float(20.0, "Take Profit (%)", minval=5.0, maxval=50.0, step=5.0, group=grpRisk)
useTrailingStop = input.bool(true, "Use Trailing Stop", group=grpRisk)
trailPercent = input.float(8.0, "Trailing Stop (%)", minval=3.0, maxval=20.0, step=1.0, group=grpRisk)
trailActivation = input.float(10.0, "Trail Activation (%)", minval=5.0, maxval=30.0, step=1.0, group=grpRisk)

grpTrend = "═══ Trend Detection ═══"
trendMethod = input.string("EMA Cross", "Trend Method", options=["EMA Cross", "SuperTrend", "Donchian"], group=grpTrend)
fastEMA = input.int(21, "Fast EMA", minval=5, maxval=50, group=grpTrend)
slowEMA = input.int(55, "Slow EMA", minval=20, maxval=200, group=grpTrend)
trendEMA = input.int(200, "Trend EMA", minval=100, maxval=500, group=grpTrend)
superTrendMult = input.float(3.0, "SuperTrend Multiplier", minval=1.0, maxval=5.0, step=0.5, group=grpTrend)
donchianLength = input.int(20, "Donchian Length", minval=10, maxval=50, group=grpTrend)

grpFilter = "═══ Entry Filters ═══"
useHTFFilter = input.bool(true, "Use Weekly Trend Filter", group=grpFilter)
htfTimeframe = input.timeframe("W", "HTF Timeframe", group=grpFilter)
useVolumeFilter = input.bool(true, "Use Volume Filter", group=grpFilter)
volumeMultiple = input.float(1.2, "Volume Multiple", minval=1.0, maxval=3.0, step=0.1, group=grpFilter)
useMomentumFilter = input.bool(true, "Use Momentum Filter", group=grpFilter)
rsiLength = input.int(14, "RSI Length", minval=7, maxval=21, group=grpFilter)
rsiLongThreshold = input.int(45, "RSI Long Above", minval=30, maxval=60, group=grpFilter)
rsiShortThreshold = input.int(55, "RSI Short Below", minval=40, maxval=70, group=grpFilter)

grpSignal = "═══ Signal Types ═══"
useEMACross = input.bool(true, "Use EMA Cross Signals", group=grpSignal)
useBreakout = input.bool(true, "Use Breakout Signals", group=grpSignal)
usePullback = input.bool(true, "Use Pullback Signals", group=grpSignal)
breakoutLength = input.int(20, "Breakout Length", minval=10, maxval=50, group=grpSignal)
pullbackBars = input.int(3, "Pullback Bars", minval=2, maxval=10, group=grpSignal)

grpTiming = "═══ Trade Timing ═══"
minBarsBetween = input.int(5, "Min Bars Between Entries", minval=1, maxval=20, group=grpTiming)
allowLong = input.bool(true, "Allow Long Trades", group=grpTiming)
allowShort = input.bool(true, "Allow Short Trades", group=grpTiming)

// ═══════════════════════════════════════════════════════════════════════════
//                              CALCULATIONS
// ═══════════════════════════════════════════════════════════════════════════

// EMAs
emaFast = ta.ema(close, fastEMA)
emaSlow = ta.ema(close, slowEMA)
emaTrend = ta.ema(close, trendEMA)

// SuperTrend
atr = ta.atr(14)
[superTrend, stDirection] = ta.supertrend(superTrendMult, 14)

// Donchian Channel
donchianHigh = ta.highest(high, donchianLength)
donchianLow = ta.lowest(low, donchianLength)
donchianMid = (donchianHigh + donchianLow) / 2

// Volume
volumeSMA = ta.sma(volume, 20)
highVolume = volume > volumeSMA * volumeMultiple

// RSI
rsi = ta.rsi(close, rsiLength)

// HTF Trend
htfEMA = request.security(syminfo.tickerid, htfTimeframe, ta.ema(close, 21), lookahead=barmerge.lookahead_off)
htfClose = request.security(syminfo.tickerid, htfTimeframe, close, lookahead=barmerge.lookahead_off)
htfBullish = htfClose > htfEMA
htfBearish = htfClose < htfEMA

// ═══════════════════════════════════════════════════════════════════════════
//                              TREND DETECTION
// ═══════════════════════════════════════════════════════════════════════════

var bool isBullTrend = false
var bool isBearTrend = false

if trendMethod == "EMA Cross"
    isBullTrend := emaFast > emaSlow and close > emaTrend
    isBearTrend := emaFast < emaSlow and close < emaTrend
else if trendMethod == "SuperTrend"
    isBullTrend := stDirection < 0 and close > emaTrend
    isBearTrend := stDirection > 0 and close < emaTrend
else if trendMethod == "Donchian"
    isBullTrend := close > donchianMid and close > emaTrend
    isBearTrend := close < donchianMid and close < emaTrend

// ═══════════════════════════════════════════════════════════════════════════
//                              SIGNAL DETECTION
// ═══════════════════════════════════════════════════════════════════════════

// EMA Cross Signals
emaCrossLong = useEMACross and ta.crossover(emaFast, emaSlow)
emaCrossShort = useEMACross and ta.crossunder(emaFast, emaSlow)

// Breakout Signals
breakoutHigh = ta.highest(high, breakoutLength)[1]
breakoutLow = ta.lowest(low, breakoutLength)[1]
breakoutLong = useBreakout and close > breakoutHigh and close[1] <= breakoutHigh
breakoutShort = useBreakout and close < breakoutLow and close[1] >= breakoutLow

// Pullback Signals (retracement to fast EMA in trend)
pullbackToEMA = math.abs(low - emaFast) < atr * 0.5 or math.abs(high - emaFast) < atr * 0.5
priceAboveEMA = close > emaFast and close[1] > emaFast
priceBelowEMA = close < emaFast and close[1] < emaFast

// Count consecutive red/green bars
var int redBars = 0
var int greenBars = 0
if close < open
    redBars += 1
    greenBars := 0
else
    greenBars += 1
    redBars := 0

pullbackLong = usePullback and isBullTrend and redBars >= pullbackBars and close > emaFast
pullbackShort = usePullback and isBearTrend and greenBars >= pullbackBars and close < emaFast

// ═══════════════════════════════════════════════════════════════════════════
//                              ENTRY CONDITIONS
// ═══════════════════════════════════════════════════════════════════════════

var int lastEntryBar = -1000

// Filters
htfFilter = not useHTFFilter or (htfBullish and allowLong) or (htfBearish and allowShort)
volumeFilter = not useVolumeFilter or highVolume
momentumFilterLong = not useMomentumFilter or rsi > rsiLongThreshold
momentumFilterShort = not useMomentumFilter or rsi < rsiShortThreshold

canEnter = bar_index - lastEntryBar >= minBarsBetween

// Long Conditions
longSignal = (emaCrossLong or breakoutLong or pullbackLong)
longCondition = canEnter and allowLong and isBullTrend and longSignal and volumeFilter and momentumFilterLong
longCondition := longCondition and (not useHTFFilter or htfBullish)

// Short Conditions
shortSignal = (emaCrossShort or breakoutShort or pullbackShort)
shortCondition = canEnter and allowShort and isBearTrend and shortSignal and volumeFilter and momentumFilterShort
shortCondition := shortCondition and (not useHTFFilter or htfBearish)

// Pyramid Conditions
currentProfit = strategy.position_size > 0 ? (close - strategy.position_avg_price) / strategy.position_avg_price * 100 : strategy.position_size < 0 ? (strategy.position_avg_price - close) / strategy.position_avg_price * 100 : 0
canPyramid = strategy.opentrades < maxPyramiding and currentProfit >= pyramidThreshold

pyramidLong = strategy.position_size > 0 and canPyramid and isBullTrend and (pullbackLong or breakoutLong)
pyramidShort = strategy.position_size < 0 and canPyramid and isBearTrend and (pullbackShort or breakoutShort)

// ═══════════════════════════════════════════════════════════════════════════
//                              EXECUTION
// ═══════════════════════════════════════════════════════════════════════════

// Calculate position size
qty = positionSize

// Long Entry
if longCondition and strategy.position_size <= 0
    strategy.close("Short", comment="Close Short")
    strategy.entry("Long", strategy.long, qty=qty, comment="Long Entry")
    lastEntryBar := bar_index

// Pyramid Long
if pyramidLong
    strategy.entry("Long", strategy.long, qty=qty/2, comment="Pyramid Long")
    lastEntryBar := bar_index

// Short Entry
if shortCondition and strategy.position_size >= 0
    strategy.close("Long", comment="Close Long")
    strategy.entry("Short", strategy.short, qty=qty, comment="Short Entry")
    lastEntryBar := bar_index

// Pyramid Short
if pyramidShort
    strategy.entry("Short", strategy.short, qty=qty/2, comment="Pyramid Short")
    lastEntryBar := bar_index

// ═══════════════════════════════════════════════════════════════════════════
//                              EXIT MANAGEMENT
// ═══════════════════════════════════════════════════════════════════════════

// Stop Loss
if useStopLoss
    if strategy.position_size > 0
        stopPrice = strategy.position_avg_price * (1 - stopLossPercent / 100)
        strategy.exit("Long SL", "Long", stop=stopPrice)
    if strategy.position_size < 0
        stopPrice = strategy.position_avg_price * (1 + stopLossPercent / 100)
        strategy.exit("Short SL", "Short", stop=stopPrice)

// Take Profit
if useTakeProfit
    if strategy.position_size > 0
        tpPrice = strategy.position_avg_price * (1 + takeProfitPercent / 100)
        strategy.exit("Long TP", "Long", limit=tpPrice)
    if strategy.position_size < 0
        tpPrice = strategy.position_avg_price * (1 - takeProfitPercent / 100)
        strategy.exit("Short TP", "Short", limit=tpPrice)

// Trailing Stop
if useTrailingStop and currentProfit >= trailActivation
    if strategy.position_size > 0
        trailPrice = close * (1 - trailPercent / 100)
        strategy.exit("Long Trail", "Long", stop=trailPrice)
    if strategy.position_size < 0
        trailPrice = close * (1 + trailPercent / 100)
        strategy.exit("Short Trail", "Short", stop=trailPrice)

// Trend Reversal Exit
if strategy.position_size > 0 and isBearTrend and ta.crossunder(emaFast, emaSlow)
    strategy.close("Long", comment="Trend Reversal")
if strategy.position_size < 0 and isBullTrend and ta.crossover(emaFast, emaSlow)
    strategy.close("Short", comment="Trend Reversal")

// ═══════════════════════════════════════════════════════════════════════════
//                              VISUALS
// ═══════════════════════════════════════════════════════════════════════════

// EMAs
plot(emaFast, "Fast EMA", color=color.new(color.blue, 30), linewidth=2)
plot(emaSlow, "Slow EMA", color=color.new(color.orange, 30), linewidth=2)
plot(emaTrend, "Trend EMA", color=color.new(color.gray, 50), linewidth=1)

// Trend Background
bgcolor(isBullTrend ? color.new(color.green, 95) : isBearTrend ? color.new(color.red, 95) : na)

// Entry Signals - Simple markers only
plotshape(longCondition, title="Long", location=location.belowbar, style=shape.triangleup, size=size.small, color=color.green)
plotshape(shortCondition, title="Short", location=location.abovebar, style=shape.triangledown, size=size.small, color=color.red)
plotshape(pyramidLong, title="Pyramid L", location=location.belowbar, style=shape.triangleup, size=size.tiny, color=color.lime)
plotshape(pyramidShort, title="Pyramid S", location=location.abovebar, style=shape.triangledown, size=size.tiny, color=color.maroon)

// ═══════════════════════════════════════════════════════════════════════════
//                              INFO TABLE
// ═══════════════════════════════════════════════════════════════════════════

var table infoTbl = table.new(position=position.top_right, columns=2, rows=7, bgcolor=color.new(color.black, 85), border_width=1, border_color=color.gray)

if barstate.islast
    table.cell(infoTbl, 0, 0, "EPA v4 Trend", text_color=color.white, text_size=size.tiny, bgcolor=color.new(color.purple, 70))
    table.cell(infoTbl, 1, 0, syminfo.ticker, text_color=color.yellow, text_size=size.tiny, bgcolor=color.new(color.purple, 70))

    trendText = isBullTrend ? "BULL" : isBearTrend ? "BEAR" : "NEUTRAL"
    trendCol = isBullTrend ? color.green : isBearTrend ? color.red : color.gray
    table.cell(infoTbl, 0, 1, "Trend", text_color=color.gray, text_size=size.tiny)
    table.cell(infoTbl, 1, 1, trendText, text_color=trendCol, text_size=size.tiny)

    htfText = htfBullish ? "BULL" : "BEAR"
    htfCol = htfBullish ? color.green : color.red
    table.cell(infoTbl, 0, 2, "HTF (" + htfTimeframe + ")", text_color=color.gray, text_size=size.tiny)
    table.cell(infoTbl, 1, 2, htfText, text_color=htfCol, text_size=size.tiny)

    posText = strategy.position_size > 0 ? "LONG x" + str.tostring(strategy.opentrades) : strategy.position_size < 0 ? "SHORT x" + str.tostring(strategy.opentrades) : "FLAT"
    posCol = strategy.position_size > 0 ? color.green : strategy.position_size < 0 ? color.red : color.gray
    table.cell(infoTbl, 0, 3, "Position", text_color=color.gray, text_size=size.tiny)
    table.cell(infoTbl, 1, 3, posText, text_color=posCol, text_size=size.tiny)

    table.cell(infoTbl, 0, 4, "Unrealized", text_color=color.gray, text_size=size.tiny)
    table.cell(infoTbl, 1, 4, str.tostring(currentProfit, "#.##") + "%", text_color=currentProfit >= 0 ? color.green : color.red, text_size=size.tiny)

    winRate = strategy.closedtrades > 0 ? strategy.wintrades / strategy.closedtrades * 100 : 0
    table.cell(infoTbl, 0, 5, "Win Rate", text_color=color.gray, text_size=size.tiny)
    table.cell(infoTbl, 1, 5, str.tostring(winRate, "#.#") + "%", text_color=winRate >= 40 ? color.green : color.red, text_size=size.tiny)

    table.cell(infoTbl, 0, 6, "Net P/L", text_color=color.gray, text_size=size.tiny)
    table.cell(infoTbl, 1, 6, str.tostring(strategy.netprofit, "#.##"), text_color=strategy.netprofit >= 0 ? color.green : color.red, text_size=size.tiny)

// ═══════════════════════════════════════════════════════════════════════════
// END OF STRATEGY v4
// ═══════════════════════════════════════════════════════════════════════════
