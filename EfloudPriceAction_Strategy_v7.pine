// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EPA Strategy v7.0 - PROFESSIONAL EDITION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// Developed by: EMRE ULUDAÅDEMIR
// Role: Financial Markets Researcher & Algorithm Designer
//
// UPGRADES FROM v6:
// âœ… Market Regime Filtering (ADX + Choppiness Index)
// âœ… Dynamic ATR Chandelier Exit
// âœ… SFP with Close Confirmation & Volume
// âœ… Trend-aware entry logic
//
// Research Focus: Price Action, Market Structure, Liquidity Analysis
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

//@version=6
strategy("EPA Strategy v7", shorttitle="EPA-v7", overlay=true,
         default_qty_type=strategy.percent_of_equity, default_qty_value=10,
         initial_capital=10000, commission_type=strategy.commission.percent,
         commission_value=0.1, slippage=2, pyramiding=3, calc_on_every_tick=false,
         process_orders_on_close=true)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                              INPUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

grpTrend = "ğŸ“ˆ Trend Settings"
fastLen = input.int(10, "Fast EMA", minval=5, maxval=30, group=grpTrend)
slowLen = input.int(30, "Slow EMA", minval=20, maxval=100, group=grpTrend)
trendLen = input.int(100, "Trend EMA", minval=50, maxval=200, group=grpTrend)

grpRegime = "ğŸ¯ Market Regime Filter"
useRegimeFilter = input.bool(true, "Enable Regime Filter", group=grpRegime)
adxLen = input.int(14, "ADX Length", minval=7, maxval=30, group=grpRegime)
adxThreshold = input.float(30.0, "ADX Trending Threshold", minval=15, maxval=50, group=grpRegime)
chopLen = input.int(14, "Choppiness Length", minval=7, maxval=30, group=grpRegime)
chopThreshold = input.float(60.0, "Choppiness Threshold", minval=40, maxval=80, group=grpRegime)

grpRisk = "âš ï¸ Dynamic Risk Management"
useATRStop = input.bool(true, "Use ATR Chandelier Exit", group=grpRisk)
atrMult = input.float(2.5, "ATR Multiplier", minval=1.0, maxval=5.0, step=0.1, group=grpRisk)
atrPeriod = input.int(14, "ATR Period", minval=7, maxval=30, group=grpRisk)
chandelierLen = input.int(22, "Chandelier Lookback", minval=10, maxval=50, group=grpRisk)
// Fallback static stops
staticStopPct = input.float(5.0, "Static Stop Loss % (fallback)", minval=1.0, maxval=15.0, step=0.5, group=grpRisk)
takeProfitPct = input.float(10.0, "Take Profit %", minval=2.0, maxval=30.0, step=1.0, group=grpRisk)

grpSignal = "ğŸ“Š Signal Settings"
useEMACross = input.bool(true, "EMA Cross Signals", group=grpSignal)
useBreakout = input.bool(true, "Breakout Signals", group=grpSignal)
breakoutLen = input.int(20, "Breakout Length", minval=10, maxval=50, group=grpSignal)
usePullback = input.bool(true, "Pullback Signals", group=grpSignal)
useSFP = input.bool(true, "SFP Signals (Swing Failure)", group=grpSignal)

grpVolume = "ğŸ“¦ Volume Filter"
useVolumeFilter = input.bool(true, "Volume Confirmation", group=grpVolume)
volumeLen = input.int(20, "Volume SMA Length", minval=10, maxval=50, group=grpVolume)
volumeMult = input.float(1.2, "Volume Spike Multiplier", minval=1.0, maxval=3.0, step=0.1, group=grpVolume)

grpHTF = "ğŸŒ Higher Timeframe"
useHTF = input.bool(false, "Weekly Trend Filter", group=grpHTF)

grpTrade = "ğŸ”§ Trade Settings"
allowLong = input.bool(true, "Allow Long", group=grpTrade)
allowShort = input.bool(true, "Allow Short", group=grpTrade)
minBars = input.int(5, "Min Bars Between", minval=1, maxval=20, group=grpTrade)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                         MARKET REGIME CALCULATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ADX Calculation
[diPlus, diMinus, adxValue] = ta.dmi(adxLen, adxLen)
isStrongTrend = adxValue > adxThreshold
isTrendingUp = diPlus > diMinus
isTrendingDown = diMinus > diPlus

// Choppiness Index Calculation
atrSum = math.sum(ta.tr(true), chopLen)
highLowRange = ta.highest(high, chopLen) - ta.lowest(low, chopLen)
chopIndex = highLowRange > 0 ? 100 * math.log10(atrSum / highLowRange) / math.log10(chopLen) : 50
isChoppy = chopIndex > chopThreshold

// Market Regime Classification
var string marketRegime = "NORMAL"
if useRegimeFilter
    if isStrongTrend and not isChoppy
        marketRegime := isTrendingUp ? "TRENDING_UP" : "TRENDING_DOWN"
    else if isChoppy and not isStrongTrend
        marketRegime := "RANGING"
    else
        marketRegime := "NORMAL"
else
    marketRegime := "NORMAL"

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                              CORE CALCULATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// EMAs
emaFast = ta.ema(close, fastLen)
emaSlow = ta.ema(close, slowLen)
emaTrend = ta.ema(close, trendLen)

// ATR
atr = ta.atr(atrPeriod)

// Chandelier Exit
chandelierLong = ta.highest(high, chandelierLen) - atr * atrMult
chandelierShort = ta.lowest(low, chandelierLen) + atr * atrMult

// Breakout levels (offset to prevent lookahead)
highestHigh = ta.highest(high, breakoutLen)[1]
lowestLow = ta.lowest(low, breakoutLen)[1]

// Volume analysis
volumeSMA = ta.sma(volume, volumeLen)
volumeRatio = volume / volumeSMA
volumeSpike = volumeRatio > volumeMult

// HTF (no lookahead)
htfEma = request.security(syminfo.tickerid, "W", ta.ema(close, 21), lookahead=barmerge.lookahead_off)
htfClose = request.security(syminfo.tickerid, "W", close, lookahead=barmerge.lookahead_off)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                              TREND DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

upTrend = emaFast > emaSlow
downTrend = emaFast < emaSlow
strongUp = upTrend and close > emaTrend
strongDown = downTrend and close < emaTrend

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                              SIGNAL DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// EMA Cross
emaCrossUp = useEMACross and ta.crossover(emaFast, emaSlow)
emaCrossDown = useEMACross and ta.crossunder(emaFast, emaSlow)

// Breakout
breakoutUp = useBreakout and close > highestHigh and close[1] <= highestHigh
breakoutDown = useBreakout and close < lowestLow and close[1] >= lowestLow

// Pullback to EMA in trend
pullbackUp = usePullback and upTrend and low <= emaFast and close > emaFast and close > open
pullbackDown = usePullback and downTrend and high >= emaFast and close < emaFast and close < open

// SFP (Swing Failure Pattern) with Close Confirmation + Volume
sfpBullish = useSFP and low < lowestLow and close > lowestLow and close > open and volumeSpike
sfpBearish = useSFP and high > highestHigh and close < highestHigh and close < open and volumeSpike

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                         REGIME-AWARE SIGNAL LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Volume filter
volumeOK = not useVolumeFilter or volumeSpike

// HTF filter
htfOK_Long = not useHTF or htfClose > htfEma
htfOK_Short = not useHTF or htfClose < htfEma

// Bar spacing
var int lastBar = 0
canTrade = bar_index - lastBar >= minBars

// === LONG SIGNALS ===
// Trending Up: Only trend-continuation (breakout + pullback)
trendLong = (marketRegime == "TRENDING_UP") and (breakoutUp or pullbackUp) and strongUp

// Ranging: Only SFP reversals
rangeLong = (marketRegime == "RANGING") and sfpBullish

// Normal: All signals
normalLong = (marketRegime == "NORMAL") and upTrend and (emaCrossUp or breakoutUp or pullbackUp)

longSignal = trendLong or rangeLong or normalLong

// === SHORT SIGNALS ===
trendShort = (marketRegime == "TRENDING_DOWN") and (breakoutDown or pullbackDown) and strongDown
rangeShort = (marketRegime == "RANGING") and sfpBearish
normalShort = (marketRegime == "NORMAL") and downTrend and (emaCrossDown or breakoutDown or pullbackDown)

shortSignal = trendShort or rangeShort or normalShort

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                              ENTRY CONDITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

longCond = allowLong and canTrade and longSignal and volumeOK and htfOK_Long
shortCond = allowShort and canTrade and shortSignal and volumeOK and htfOK_Short

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                              EXECUTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Long entry
if longCond and strategy.position_size <= 0
    strategy.close("Short")
    strategy.entry("Long", strategy.long)
    lastBar := bar_index

// Short entry
if shortCond and strategy.position_size >= 0
    strategy.close("Long")
    strategy.entry("Short", strategy.short)
    lastBar := bar_index

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                              EXITS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Dynamic ATR-based stop or static fallback
if strategy.position_size > 0
    stopPrice = useATRStop ? chandelierLong : strategy.position_avg_price * (1 - staticStopPct / 100)
    tpPrice = strategy.position_avg_price * (1 + takeProfitPct / 100)
    strategy.exit("Long Exit", "Long", stop=stopPrice, limit=tpPrice)

if strategy.position_size < 0
    stopPrice = useATRStop ? chandelierShort : strategy.position_avg_price * (1 + staticStopPct / 100)
    tpPrice = strategy.position_avg_price * (1 - takeProfitPct / 100)
    strategy.exit("Short Exit", "Short", stop=stopPrice, limit=tpPrice)

// Trend reversal exit
if strategy.position_size > 0 and ta.crossunder(emaFast, emaSlow)
    strategy.close("Long", comment="Trend Rev")

if strategy.position_size < 0 and ta.crossover(emaFast, emaSlow)
    strategy.close("Short", comment="Trend Rev")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                              VISUALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// EMAs
plot(emaFast, "Fast EMA", color=color.blue, linewidth=2)
plot(emaSlow, "Slow EMA", color=color.orange, linewidth=2)
plot(emaTrend, "Trend EMA", color=color.gray, linewidth=1)

// Chandelier Exits
plot(useATRStop and strategy.position_size > 0 ? chandelierLong : na, "Chandelier Long", color=color.green, style=plot.style_linebr, linewidth=1)
plot(useATRStop and strategy.position_size < 0 ? chandelierShort : na, "Chandelier Short", color=color.red, style=plot.style_linebr, linewidth=1)

// Trend background
bgcolor(upTrend ? color.new(color.green, 95) : downTrend ? color.new(color.red, 95) : na)

// Market Regime indicator
regimeColor = marketRegime == "TRENDING_UP" ? color.new(color.teal, 80) : 
              marketRegime == "TRENDING_DOWN" ? color.new(color.maroon, 80) :
              marketRegime == "RANGING" ? color.new(color.yellow, 80) : na
bgcolor(regimeColor, title="Market Regime")

// Entry signals
plotshape(longCond, "Long", location.belowbar, shape.triangleup, size.normal, color.green)
plotshape(shortCond, "Short", location.abovebar, shape.triangledown, size.normal, color.red)

// Signal type markers
plotshape(emaCrossUp, "EMA Cross Up", location.belowbar, shape.circle, size.tiny, color.lime)
plotshape(emaCrossDown, "EMA Cross Down", location.abovebar, shape.circle, size.tiny, color.maroon)
plotshape(breakoutUp, "Breakout Up", location.belowbar, shape.diamond, size.tiny, color.teal)
plotshape(breakoutDown, "Breakout Down", location.abovebar, shape.diamond, size.tiny, color.purple)
plotshape(sfpBullish, "SFP Bull", location.belowbar, shape.square, size.tiny, color.aqua)
plotshape(sfpBearish, "SFP Bear", location.abovebar, shape.square, size.tiny, color.fuchsia)

// Info table
var table infoTable = table.new(position.top_right, 2, 4, bgcolor=color.new(color.black, 80))
if barstate.islast
    table.cell(infoTable, 0, 0, "ADX", text_color=color.white)
    table.cell(infoTable, 1, 0, str.tostring(adxValue, "#.0"), text_color=isStrongTrend ? color.green : color.gray)
    table.cell(infoTable, 0, 1, "Chop", text_color=color.white)
    table.cell(infoTable, 1, 1, str.tostring(chopIndex, "#.0"), text_color=isChoppy ? color.red : color.gray)
    table.cell(infoTable, 0, 2, "Regime", text_color=color.white)
    table.cell(infoTable, 1, 2, marketRegime, text_color=color.yellow)
    table.cell(infoTable, 0, 3, "ATR", text_color=color.white)
    table.cell(infoTable, 1, 3, str.tostring(atr, "#.00"), text_color=color.white)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EPA v7 - Professional Edition with Market Regime Filtering
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
