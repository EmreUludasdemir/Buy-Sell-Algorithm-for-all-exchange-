// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Efloud Price Action Trading System
// Based on @EfloudTheSurfer's methodology

//@version=6
indicator("Efloud Price Action System", shorttitle="EPA", overlay=true, max_boxes_count=500, max_lines_count=500, max_labels_count=500)

// ══════════════════════════════════════════════════════════════════════════════
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
//                              INPUT SETTINGS
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
// ══════════════════════════════════════════════════════════════════════════════

// ─────────────────── Structure Settings ───────────────────
grpStructure = "═══ Range Structure Settings ═══"
pivotLookback = input.int(10, "Pivot Lookback Period", minval=3, maxval=50, group=grpStructure, tooltip="Number of bars to look back for swing high/low detection")
pivotLookforward = input.int(10, "Pivot Lookforward Period", minval=3, maxval=50, group=grpStructure, tooltip="Number of bars to look forward for swing confirmation")
showRangeLines = input.bool(true, "Show RH/RL/EQ Lines", group=grpStructure)
showZoneBoxes = input.bool(true, "Show Supply/Demand Boxes", group=grpStructure)
zoneExtendBars = input.int(50, "Zone Extension (Bars)", minval=10, maxval=200, group=grpStructure)

// ─────────────────── Zone Settings ───────────────────
grpZones = "═══ Zone Visualization ═══"
demandColor = input.color(color.new(color.green, 80), "Demand Zone Color (Green Box)", group=grpZones)
demandBorderColor = input.color(color.new(color.green, 40), "Demand Zone Border", group=grpZones)
supplyColor = input.color(color.new(color.red, 80), "Supply Zone Color (Red Box)", group=grpZones)
supplyBorderColor = input.color(color.new(color.red, 40), "Supply Zone Border", group=grpZones)
eqColor = input.color(color.new(color.blue, 70), "EQ Zone Color (Blue Box)", group=grpZones)
eqBorderColor = input.color(color.new(color.blue, 30), "EQ Zone Border", group=grpZones)
zoneWidth = input.int(2, "Zone Border Width", minval=1, maxval=5, group=grpZones)

// ─────────────────── Pattern Detection Settings ───────────────────
grpPatterns = "═══ Pattern Detection ═══"
showSFP = input.bool(true, "Show Swing Failure Patterns (SFP)", group=grpPatterns)
sfpWickRatio = input.float(2.0, "SFP Wick/Body Ratio", minval=1.0, maxval=5.0, step=0.1, group=grpPatterns, tooltip="Minimum wick to body ratio for SFP detection")
showBreakers = input.bool(true, "Show Breaker Blocks", group=grpPatterns)
showMitigation = input.bool(true, "Show Mitigation Blocks", group=grpPatterns)

// ─────────────────── EQH/EQL Settings ───────────────────
grpEQL = "═══ Equal Highs/Lows (Liquidity) ═══"
showEQHL = input.bool(true, "Show EQH/EQL Levels", group=grpEQL)
eqhlThreshold = input.float(0.1, "EQH/EQL Threshold (%)", minval=0.01, maxval=1.0, step=0.01, group=grpEQL, tooltip="Percentage threshold to consider highs/lows as 'equal'")
eqhlExpireBars = input.int(100, "EQH/EQL Expire After (Bars)", minval=20, maxval=500, group=grpEQL)
eqhColor = input.color(color.new(color.orange, 50), "EQH Color (Bearish Bias)", group=grpEQL)
eqlColor = input.color(color.new(color.teal, 50), "EQL Color (Bullish Bias)", group=grpEQL)

// ─────────────────── MTF Dashboard Settings ───────────────────
grpMTF = "═══ Multi-Timeframe Dashboard ═══"
showDashboard = input.bool(true, "Show MTF Dashboard", group=grpMTF)
dashboardPosition = input.string("Top Right", "Dashboard Position", options=["Top Right", "Top Left", "Bottom Right", "Bottom Left"], group=grpMTF)
htfTimeframe1 = input.timeframe("D", "HTF 1 (Trend Direction)", group=grpMTF)
htfTimeframe2 = input.timeframe("240", "HTF 2 (Structure)", group=grpMTF)
ltfTimeframe1 = input.timeframe("60", "LTF 1 (Entry Validation)", group=grpMTF)
ltfTimeframe2 = input.timeframe("15", "LTF 2 (Entry Refinement)", group=grpMTF)

// ─────────────────── Indicator Settings (Optional) ───────────────────
grpIndicators = "═══ Optional Indicators (HTF Only) ═══"
showRSI = input.bool(false, "Show RSI Status", group=grpIndicators)
rsiLength = input.int(14, "RSI Length", minval=5, maxval=50, group=grpIndicators)
rsiOverbought = input.int(70, "RSI Overbought", minval=60, maxval=90, group=grpIndicators)
rsiOversold = input.int(30, "RSI Oversold", minval=10, maxval=40, group=grpIndicators)
showOBV = input.bool(false, "Show OBV Trend", group=grpIndicators)
obvLength = input.int(9, "OBV MA Length", minval=3, maxval=30, group=grpIndicators)
showDMA = input.bool(false, "Show DMA (50 EMA)", group=grpIndicators)
dmaLength = input.int(50, "DMA Length", minval=10, maxval=200, group=grpIndicators)

// ─────────────────── Alert Settings ───────────────────
grpAlerts = "═══ Alert Conditions ═══"
alertDemandEntry = input.bool(true, "Alert: Price Enters Demand Zone", group=grpAlerts)
alertSupplyEntry = input.bool(true, "Alert: Price Enters Supply Zone", group=grpAlerts)
alertSFP = input.bool(true, "Alert: SFP Formation", group=grpAlerts)
alertEQBreak = input.bool(true, "Alert: EQ Level Break", group=grpAlerts)
alertBreaker = input.bool(true, "Alert: Breaker Block Retest", group=grpAlerts)
alertEQHL = input.bool(true, "Alert: EQH/EQL Formation", group=grpAlerts)

// ─────────────────── Visual Settings ───────────────────
grpVisual = "═══ Visual Settings ═══"
labelSize = input.string("small", "Label Size", options=["tiny", "small", "normal", "large"], group=grpVisual)
showLabels = input.bool(true, "Show Pattern Labels", group=grpVisual)
showRiskReward = input.bool(true, "Show Risk/Reward Calculation", group=grpVisual)
minRiskReward = input.float(2.0, "Minimum R:R Ratio", minval=1.0, maxval=10.0, step=0.5, group=grpVisual)

// ══════════════════════════════════════════════════════════════════════════════
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
//                            HELPER FUNCTIONS
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
// ══════════════════════════════════════════════════════════════════════════════

// Get label size constant
getLabelSize(sizeStr) =>
    switch sizeStr
        "tiny" => size.tiny
        "small" => size.small
        "normal" => size.normal
        "large" => size.large
        => size.small

// Get dashboard position
getDashboardPosition(posStr) =>
    switch posStr
        "Top Right" => position.top_right
        "Top Left" => position.top_left
        "Bottom Right" => position.bottom_right
        "Bottom Left" => position.bottom_left
        => position.top_right

// Calculate body and wick sizes
bodySize = math.abs(close - open)
upperWick = high - math.max(close, open)
lowerWick = math.min(close, open) - low
totalWick = upperWick + lowerWick

// Bullish and bearish candle detection
isBullish = close > open
isBearish = close < open

// ══════════════════════════════════════════════════════════════════════════════
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
//                         RANGE STRUCTURE ENGINE
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
// ══════════════════════════════════════════════════════════════════════════════

// Pivot High/Low Detection
pivotHigh = ta.pivothigh(high, pivotLookback, pivotLookforward)
pivotLow = ta.pivotlow(low, pivotLookback, pivotLookforward)

// Store range values
var float rangeHigh = na
var float rangeLow = na
var float equilibrium = na
var int rhBar = na
var int rlBar = na

// Update Range High
if not na(pivotHigh)
    rangeHigh := pivotHigh
    rhBar := bar_index - pivotLookforward

// Update Range Low
if not na(pivotLow)
    rangeLow := pivotLow
    rlBar := bar_index - pivotLookforward

// Calculate Equilibrium: EQ = (RH + RL) / 2
if not na(rangeHigh) and not na(rangeLow)
    equilibrium := (rangeHigh + rangeLow) / 2

// ─────────────────── Draw Range Lines ───────────────────
var line rhLine = na
var line rlLine = na
var line eqLine = na

if showRangeLines and barstate.islast
    // Delete old lines
    line.delete(rhLine)
    line.delete(rlLine)
    line.delete(eqLine)

    // Draw new lines
    if not na(rangeHigh)
        rhLine := line.new(bar_index - 50, rangeHigh, bar_index + 10, rangeHigh,
                          color=supplyBorderColor, width=2, style=line.style_solid)
        label.new(bar_index + 12, rangeHigh, "RH", style=label.style_label_left,
                 color=color.new(color.red, 80), textcolor=color.red, size=getLabelSize(labelSize))

    if not na(rangeLow)
        rlLine := line.new(bar_index - 50, rangeLow, bar_index + 10, rangeLow,
                          color=demandBorderColor, width=2, style=line.style_solid)
        label.new(bar_index + 12, rangeLow, "RL", style=label.style_label_left,
                 color=color.new(color.green, 80), textcolor=color.green, size=getLabelSize(labelSize))

    if not na(equilibrium)
        eqLine := line.new(bar_index - 50, equilibrium, bar_index + 10, equilibrium,
                          color=eqBorderColor, width=2, style=line.style_dashed)
        label.new(bar_index + 12, equilibrium, "EQ", style=label.style_label_left,
                 color=color.new(color.blue, 80), textcolor=color.blue, size=getLabelSize(labelSize))

// ══════════════════════════════════════════════════════════════════════════════
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
//                        SUPPLY/DEMAND ZONE BOXES
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
// ══════════════════════════════════════════════════════════════════════════════

// Arrays to store zone data
var box[] demandBoxes = array.new_box()
var box[] supplyBoxes = array.new_box()
var float[] demandTops = array.new_float()
var float[] demandBottoms = array.new_float()
var float[] supplyTops = array.new_float()
var float[] supplyBottoms = array.new_float()
var int[] demandBars = array.new_int()
var int[] supplyBars = array.new_int()

// ATR for zone sizing
atr = ta.atr(14)

// Demand Zone Detection (Bullish Order Block)
// Strong bullish move after consolidation or bearish candle
demandZoneCondition = (isBullish and
                       close > high[1] and
                       bodySize > atr * 0.5 and
                       close[1] < open[1])  // Previous candle was bearish

// Supply Zone Detection (Bearish Order Block)
// Strong bearish move after consolidation or bullish candle
supplyZoneCondition = (isBearish and
                       close < low[1] and
                       bodySize > atr * 0.5 and
                       close[1] > open[1])  // Previous candle was bullish

// Create Demand Zones
if showZoneBoxes and demandZoneCondition
    zoneTop = math.max(high[1], open[1])
    zoneBottom = low[1]

    newBox = box.new(bar_index - 1, zoneTop, bar_index + zoneExtendBars, zoneBottom,
                     bgcolor=demandColor, border_color=demandBorderColor, border_width=zoneWidth)

    array.push(demandBoxes, newBox)
    array.push(demandTops, zoneTop)
    array.push(demandBottoms, zoneBottom)
    array.push(demandBars, bar_index)

    if showLabels
        label.new(bar_index - 1, zoneTop, "DEMAND", style=label.style_label_down,
                 color=demandColor, textcolor=color.green, size=getLabelSize(labelSize))

// Create Supply Zones
if showZoneBoxes and supplyZoneCondition
    zoneTop = high[1]
    zoneBottom = math.min(low[1], open[1])

    newBox = box.new(bar_index - 1, zoneTop, bar_index + zoneExtendBars, zoneBottom,
                     bgcolor=supplyColor, border_color=supplyBorderColor, border_width=zoneWidth)

    array.push(supplyBoxes, newBox)
    array.push(supplyTops, zoneTop)
    array.push(supplyBottoms, zoneBottom)
    array.push(supplyBars, bar_index)

    if showLabels
        label.new(bar_index - 1, zoneBottom, "SUPPLY", style=label.style_label_up,
                 color=supplyColor, textcolor=color.red, size=getLabelSize(labelSize))

// Check for zone invalidation (price closes through zone)
if array.size(demandBoxes) > 0
    for i = array.size(demandBoxes) - 1 to 0
        if i < array.size(demandBottoms)
            if close < array.get(demandBottoms, i)
                box.delete(array.get(demandBoxes, i))
                array.remove(demandBoxes, i)
                array.remove(demandTops, i)
                array.remove(demandBottoms, i)
                array.remove(demandBars, i)

if array.size(supplyBoxes) > 0
    for i = array.size(supplyBoxes) - 1 to 0
        if i < array.size(supplyTops)
            if close > array.get(supplyTops, i)
                box.delete(array.get(supplyBoxes, i))
                array.remove(supplyBoxes, i)
                array.remove(supplyTops, i)
                array.remove(supplyBottoms, i)
                array.remove(supplyBars, i)

// ══════════════════════════════════════════════════════════════════════════════
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
//                    SWING FAILURE PATTERN (SFP) DETECTION
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
// ══════════════════════════════════════════════════════════════════════════════

// Find recent swing highs and lows for SFP detection
recentSwingHigh = ta.highest(high, 20)[1]
recentSwingLow = ta.lowest(low, 20)[1]

// Bearish SFP: Price wicks above swing high but closes below
bearishSFP = (showSFP and
              high > recentSwingHigh and
              close < recentSwingHigh and
              close < open and
              upperWick > bodySize * sfpWickRatio)

// Bullish SFP: Price wicks below swing low but closes above
bullishSFP = (showSFP and
              low < recentSwingLow and
              close > recentSwingLow and
              close > open and
              lowerWick > bodySize * sfpWickRatio)

// Draw SFP signals
if bearishSFP and showLabels
    label.new(bar_index, high, "SFP\n▼", style=label.style_label_down,
             color=color.new(color.red, 20), textcolor=color.white, size=getLabelSize(labelSize))

if bullishSFP and showLabels
    label.new(bar_index, low, "▲\nSFP", style=label.style_label_up,
             color=color.new(color.green, 20), textcolor=color.white, size=getLabelSize(labelSize))

// Plot SFP markers
plotshape(bearishSFP, title="Bearish SFP", location=location.abovebar,
         style=shape.triangledown, size=size.small, color=color.red)
plotshape(bullishSFP, title="Bullish SFP", location=location.belowbar,
         style=shape.triangleup, size=size.small, color=color.green)

// ══════════════════════════════════════════════════════════════════════════════
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
//                         BREAKER BLOCK DETECTION
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
// ══════════════════════════════════════════════════════════════════════════════

// Store order block data for breaker detection
var float[] obHighs = array.new_float()
var float[] obLows = array.new_float()
var int[] obBars = array.new_int()
var bool[] obBullish = array.new_bool()
var box[] breakerBoxes = array.new_box()

// Detect potential order blocks (simplified)
bullishOB = isBullish and bodySize > atr * 0.8 and close > high[1]
bearishOB = isBearish and bodySize > atr * 0.8 and close < low[1]

// Store bullish OB
if showBreakers and bullishOB
    array.push(obHighs, high)
    array.push(obLows, low[1])
    array.push(obBars, bar_index)
    array.push(obBullish, true)

// Store bearish OB
if showBreakers and bearishOB
    array.push(obHighs, high[1])
    array.push(obLows, low)
    array.push(obBars, bar_index)
    array.push(obBullish, false)

// Check for breaker formation (OB invalidation + retest)
if showBreakers and array.size(obHighs) > 0
    for i = array.size(obHighs) - 1 to 0
        if i < array.size(obHighs)
            obHigh = array.get(obHighs, i)
            obLow = array.get(obLows, i)
            obBar = array.get(obBars, i)
            wasBullish = array.get(obBullish, i)

            // Bullish OB invalidated (price closed below) - becomes bearish breaker
            if wasBullish and close[1] < obLow and high >= obLow and high <= obHigh
                if showLabels
                    label.new(bar_index, high, "BREAKER\n(Bearish)", style=label.style_label_down,
                             color=color.new(color.purple, 20), textcolor=color.white, size=getLabelSize(labelSize))
                array.remove(obHighs, i)
                array.remove(obLows, i)
                array.remove(obBars, i)
                array.remove(obBullish, i)

            // Bearish OB invalidated (price closed above) - becomes bullish breaker
            else if not wasBullish and close[1] > obHigh and low <= obHigh and low >= obLow
                if showLabels
                    label.new(bar_index, low, "BREAKER\n(Bullish)", style=label.style_label_up,
                             color=color.new(color.teal, 20), textcolor=color.white, size=getLabelSize(labelSize))
                array.remove(obHighs, i)
                array.remove(obLows, i)
                array.remove(obBars, i)
                array.remove(obBullish, i)

            // Clean up old OBs
            else if bar_index - obBar > 200
                array.remove(obHighs, i)
                array.remove(obLows, i)
                array.remove(obBars, i)
                array.remove(obBullish, i)

// Limit array sizes
if array.size(obHighs) > 50
    array.shift(obHighs)
    array.shift(obLows)
    array.shift(obBars)
    array.shift(obBullish)

// ══════════════════════════════════════════════════════════════════════════════
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
//                        MITIGATION BLOCK DETECTION
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
// ══════════════════════════════════════════════════════════════════════════════

// Mitigation blocks form from failure to swing
// Bearish mitigation: Failed to make higher high, then structure shift down
// Bullish mitigation: Failed to make lower low, then structure shift up

// Track swing structure
var float lastSwingHigh = na
var float lastSwingLow = na
var int lastSwingHighBar = na
var int lastSwingLowBar = na

if not na(pivotHigh)
    lastSwingHigh := pivotHigh
    lastSwingHighBar := bar_index - pivotLookforward

if not na(pivotLow)
    lastSwingLow := pivotLow
    lastSwingLowBar := bar_index - pivotLookforward

// Detect failure swings (mitigation setup)
// Bearish: Price attempts to break above last swing high but fails
bearishMitigation = (showMitigation and
                     not na(lastSwingHigh) and
                     high[2] > lastSwingHigh and
                     close[2] < lastSwingHigh and
                     close[1] < close[2] and
                     close < close[1])

// Bullish: Price attempts to break below last swing low but fails
bullishMitigation = (showMitigation and
                     not na(lastSwingLow) and
                     low[2] < lastSwingLow and
                     close[2] > lastSwingLow and
                     close[1] > close[2] and
                     close > close[1])

// Draw mitigation signals
if bearishMitigation and showLabels
    label.new(bar_index - 2, high[2], "MIT\n▼", style=label.style_label_down,
             color=color.new(color.maroon, 20), textcolor=color.white, size=getLabelSize(labelSize))

if bullishMitigation and showLabels
    label.new(bar_index - 2, low[2], "▲\nMIT", style=label.style_label_up,
             color=color.new(color.lime, 20), textcolor=color.white, size=getLabelSize(labelSize))

// ══════════════════════════════════════════════════════════════════════════════
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
//                   EQUAL HIGHS/LOWS (EQH/EQL) LIQUIDITY
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
// ══════════════════════════════════════════════════════════════════════════════

// Arrays for EQH/EQL tracking
var float[] eqhLevels = array.new_float()
var int[] eqhBars = array.new_int()
var line[] eqhLines = array.new_line()

var float[] eqlLevels = array.new_float()
var int[] eqlBars = array.new_int()
var line[] eqlLines = array.new_line()

// Calculate threshold
eqhlThresholdValue = close * (eqhlThreshold / 100)

// Detect Equal Highs (EQH) - Bearish liquidity
// Two or more highs at approximately the same level
eqhDetected = (showEQHL and
               not na(pivotHigh) and
               array.size(eqhLevels) > 0 and
               math.abs(pivotHigh - array.get(eqhLevels, array.size(eqhLevels) - 1)) < eqhlThresholdValue)

newEQH = (showEQHL and not na(pivotHigh) and not eqhDetected)

// Detect Equal Lows (EQL) - Bullish liquidity
eqlDetected = (showEQHL and
               not na(pivotLow) and
               array.size(eqlLevels) > 0 and
               math.abs(pivotLow - array.get(eqlLevels, array.size(eqlLevels) - 1)) < eqhlThresholdValue)

newEQL = (showEQHL and not na(pivotLow) and not eqlDetected)

// Store and draw EQH
if eqhDetected
    avgLevel = (pivotHigh + array.get(eqhLevels, array.size(eqhLevels) - 1)) / 2

    newLine = line.new(array.get(eqhBars, array.size(eqhBars) - 1), avgLevel,
                       bar_index + 20, avgLevel, color=eqhColor, width=2, style=line.style_dotted)
    array.push(eqhLines, newLine)

    if showLabels
        label.new(bar_index - pivotLookforward, avgLevel, "EQH\n(Liquidity)",
                 style=label.style_label_left, color=eqhColor, textcolor=color.white, size=getLabelSize(labelSize))

if newEQH
    array.push(eqhLevels, pivotHigh)
    array.push(eqhBars, bar_index - pivotLookforward)

// Store and draw EQL
if eqlDetected
    avgLevel = (pivotLow + array.get(eqlLevels, array.size(eqlLevels) - 1)) / 2

    newLine = line.new(array.get(eqlBars, array.size(eqlBars) - 1), avgLevel,
                       bar_index + 20, avgLevel, color=eqlColor, width=2, style=line.style_dotted)
    array.push(eqlLines, newLine)

    if showLabels
        label.new(bar_index - pivotLookforward, avgLevel, "EQL\n(Liquidity)",
                 style=label.style_label_left, color=eqlColor, textcolor=color.white, size=getLabelSize(labelSize))

if newEQL
    array.push(eqlLevels, pivotLow)
    array.push(eqlBars, bar_index - pivotLookforward)

// Clean up expired EQH/EQL
if array.size(eqhBars) > 0
    for i = array.size(eqhBars) - 1 to 0
        if bar_index - array.get(eqhBars, i) > eqhlExpireBars
            array.remove(eqhLevels, i)
            array.remove(eqhBars, i)

if array.size(eqlBars) > 0
    for i = array.size(eqlBars) - 1 to 0
        if bar_index - array.get(eqlBars, i) > eqhlExpireBars
            array.remove(eqlLevels, i)
            array.remove(eqlBars, i)

// Limit arrays
if array.size(eqhLevels) > 20
    array.shift(eqhLevels)
    array.shift(eqhBars)

if array.size(eqlLevels) > 20
    array.shift(eqlLevels)
    array.shift(eqlBars)

// ══════════════════════════════════════════════════════════════════════════════
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
//                        MULTI-TIMEFRAME DASHBOARD
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
// ══════════════════════════════════════════════════════════════════════════════

// Request MTF data
[htf1Close, htf1Open, htf1High, htf1Low] = request.security(syminfo.tickerid, htfTimeframe1, [close, open, high, low])
[htf2Close, htf2Open, htf2High, htf2Low] = request.security(syminfo.tickerid, htfTimeframe2, [close, open, high, low])
[ltf1Close, ltf1Open, ltf1High, ltf1Low] = request.security(syminfo.tickerid, ltfTimeframe1, [close, open, high, low])
[ltf2Close, ltf2Open, ltf2High, ltf2Low] = request.security(syminfo.tickerid, ltfTimeframe2, [close, open, high, low])

// Calculate EMAs for trend
htf1EMA = request.security(syminfo.tickerid, htfTimeframe1, ta.ema(close, dmaLength))
htf2EMA = request.security(syminfo.tickerid, htfTimeframe2, ta.ema(close, 20))

// Determine bias
htf1Bias = htf1Close > htf1EMA ? "BULLISH" : "BEARISH"
htf2Bias = htf2Close > htf2EMA ? "BULLISH" : "BEARISH"
ltf1Bias = ltf1Close > ltf1Open ? "BULLISH" : "BEARISH"
ltf2Bias = ltf2Close > ltf2Open ? "BULLISH" : "BEARISH"

htf1Color = htf1Close > htf1EMA ? color.green : color.red
htf2Color = htf2Close > htf2EMA ? color.green : color.red
ltf1Color = ltf1Close > ltf1Open ? color.green : color.red
ltf2Color = ltf2Close > ltf2Open ? color.green : color.red

// RSI calculation
htfRSI = request.security(syminfo.tickerid, htfTimeframe1, ta.rsi(close, rsiLength))
rsiStatus = htfRSI > 50 ? "Bullish (" + str.tostring(htfRSI, "#.#") + ")" : "Bearish (" + str.tostring(htfRSI, "#.#") + ")"
rsiColor = htfRSI > 50 ? color.green : color.red

// OBV calculation
obv = ta.obv
obvMA = ta.sma(obv, obvLength)
obvTrend = obv > obvMA ? "Bullish" : "Bearish"
obvColor = obv > obvMA ? color.green : color.red

// Create dashboard table
var table dashboard = table.new(position=getDashboardPosition(dashboardPosition), columns=3, rows=10, bgcolor=color.new(color.black, 80), border_width=1, border_color=color.gray)

if showDashboard and barstate.islast
    // Header
    table.cell(dashboard, 0, 0, "EFLOUD PA SYSTEM", text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 60))
    table.merge_cells(dashboard, 0, 0, 2, 0)

    // Timeframe headers
    table.cell(dashboard, 0, 1, "Timeframe", text_color=color.gray, text_size=size.tiny)
    table.cell(dashboard, 1, 1, "Bias", text_color=color.gray, text_size=size.tiny)
    table.cell(dashboard, 2, 1, "Status", text_color=color.gray, text_size=size.tiny)

    // HTF1 (Daily)
    table.cell(dashboard, 0, 2, htfTimeframe1 + " (HTF)", text_color=color.white, text_size=size.tiny)
    table.cell(dashboard, 1, 2, htf1Bias, text_color=htf1Color, text_size=size.tiny)
    table.cell(dashboard, 2, 2, "Trend Dir.", text_color=color.gray, text_size=size.tiny)

    // HTF2 (4H)
    table.cell(dashboard, 0, 3, htfTimeframe2 + " (4H)", text_color=color.white, text_size=size.tiny)
    table.cell(dashboard, 1, 3, htf2Bias, text_color=htf2Color, text_size=size.tiny)
    table.cell(dashboard, 2, 3, "Structure", text_color=color.gray, text_size=size.tiny)

    // LTF1 (1H)
    table.cell(dashboard, 0, 4, ltfTimeframe1 + " (1H)", text_color=color.white, text_size=size.tiny)
    table.cell(dashboard, 1, 4, ltf1Bias, text_color=ltf1Color, text_size=size.tiny)
    table.cell(dashboard, 2, 4, "Entry Val.", text_color=color.gray, text_size=size.tiny)

    // LTF2 (15M)
    table.cell(dashboard, 0, 5, ltfTimeframe2 + " (15M)", text_color=color.white, text_size=size.tiny)
    table.cell(dashboard, 1, 5, ltf2Bias, text_color=ltf2Color, text_size=size.tiny)
    table.cell(dashboard, 2, 5, "Entry Ref.", text_color=color.gray, text_size=size.tiny)

    // Separator
    table.cell(dashboard, 0, 6, "─── Indicators ───", text_color=color.gray, text_size=size.tiny)
    table.merge_cells(dashboard, 0, 6, 2, 6)

    // RSI (if enabled)
    if showRSI
        table.cell(dashboard, 0, 7, "RSI (" + str.tostring(rsiLength) + ")", text_color=color.white, text_size=size.tiny)
        table.cell(dashboard, 1, 7, rsiStatus, text_color=rsiColor, text_size=size.tiny)
        table.cell(dashboard, 2, 7, htfTimeframe1, text_color=color.gray, text_size=size.tiny)
    else
        table.cell(dashboard, 0, 7, "RSI", text_color=color.gray, text_size=size.tiny)
        table.cell(dashboard, 1, 7, "OFF", text_color=color.gray, text_size=size.tiny)
        table.cell(dashboard, 2, 7, "-", text_color=color.gray, text_size=size.tiny)

    // OBV (if enabled)
    if showOBV
        table.cell(dashboard, 0, 8, "OBV", text_color=color.white, text_size=size.tiny)
        table.cell(dashboard, 1, 8, obvTrend, text_color=obvColor, text_size=size.tiny)
        table.cell(dashboard, 2, 8, "Trend", text_color=color.gray, text_size=size.tiny)
    else
        table.cell(dashboard, 0, 8, "OBV", text_color=color.gray, text_size=size.tiny)
        table.cell(dashboard, 1, 8, "OFF", text_color=color.gray, text_size=size.tiny)
        table.cell(dashboard, 2, 8, "-", text_color=color.gray, text_size=size.tiny)

    // Range Info
    table.cell(dashboard, 0, 9, "RH: " + str.tostring(rangeHigh, "#.####"), text_color=color.red, text_size=size.tiny)
    table.cell(dashboard, 1, 9, "EQ: " + str.tostring(equilibrium, "#.####"), text_color=color.blue, text_size=size.tiny)
    table.cell(dashboard, 2, 9, "RL: " + str.tostring(rangeLow, "#.####"), text_color=color.green, text_size=size.tiny)

// ══════════════════════════════════════════════════════════════════════════════
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
//                           OPTIONAL INDICATORS
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
// ══════════════════════════════════════════════════════════════════════════════

// DMA (50 EMA as trend direction proxy)
dma = ta.ema(close, dmaLength)
plot(showDMA ? dma : na, title="DMA (50 EMA)", color=color.new(color.yellow, 30), linewidth=2)

// ══════════════════════════════════════════════════════════════════════════════
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
//                              ZONE ENTRY DETECTION
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
// ══════════════════════════════════════════════════════════════════════════════

// Check if price is in demand zone
inDemandZone = false
if array.size(demandBoxes) > 0
    for i = 0 to array.size(demandBoxes) - 1
        if i < array.size(demandTops) and i < array.size(demandBottoms)
            if low <= array.get(demandTops, i) and high >= array.get(demandBottoms, i)
                inDemandZone := true

// Check if price is in supply zone
inSupplyZone = false
if array.size(supplyBoxes) > 0
    for i = 0 to array.size(supplyBoxes) - 1
        if i < array.size(supplyTops) and i < array.size(supplyBottoms)
            if high >= array.get(supplyBottoms, i) and low <= array.get(supplyTops, i)
                inSupplyZone := true

// EQ break detection
eqBreakBullish = not na(equilibrium) and close > equilibrium and close[1] <= equilibrium
eqBreakBearish = not na(equilibrium) and close < equilibrium and close[1] >= equilibrium

// Background color for zone entry
bgcolor(inDemandZone ? color.new(color.green, 95) : na, title="In Demand Zone")
bgcolor(inSupplyZone ? color.new(color.red, 95) : na, title="In Supply Zone")

// ══════════════════════════════════════════════════════════════════════════════
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
//                           RISK/REWARD CALCULATOR
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
// ══════════════════════════════════════════════════════════════════════════════

// Calculate potential R:R for long setup (when in demand zone)
longEntry = inDemandZone ? close : na
longStop = inDemandZone and array.size(demandBottoms) > 0 ? array.get(demandBottoms, array.size(demandBottoms) - 1) - atr * 0.5 : na
longTarget = inDemandZone and not na(rangeHigh) ? rangeHigh : na

longRisk = longEntry - longStop
longReward = longTarget - longEntry
longRR = longRisk > 0 ? longReward / longRisk : 0

// Calculate potential R:R for short setup (when in supply zone)
shortEntry = inSupplyZone ? close : na
shortStop = inSupplyZone and array.size(supplyTops) > 0 ? array.get(supplyTops, array.size(supplyTops) - 1) + atr * 0.5 : na
shortTarget = inSupplyZone and not na(rangeLow) ? rangeLow : na

shortRisk = shortStop - shortEntry
shortReward = shortEntry - shortTarget
shortRR = shortRisk > 0 ? shortReward / shortRisk : 0

// Display R:R info
if showRiskReward and barstate.islast
    if inDemandZone and longRR >= minRiskReward
        label.new(bar_index, low, "LONG SETUP\nEntry: " + str.tostring(longEntry, "#.####") +
                 "\nSL: " + str.tostring(longStop, "#.####") +
                 "\nTP: " + str.tostring(longTarget, "#.####") +
                 "\nR:R = " + str.tostring(longRR, "#.##"),
                 style=label.style_label_up, color=color.new(color.green, 20),
                 textcolor=color.white, size=getLabelSize(labelSize))

    if inSupplyZone and shortRR >= minRiskReward
        label.new(bar_index, high, "SHORT SETUP\nEntry: " + str.tostring(shortEntry, "#.####") +
                 "\nSL: " + str.tostring(shortStop, "#.####") +
                 "\nTP: " + str.tostring(shortTarget, "#.####") +
                 "\nR:R = " + str.tostring(shortRR, "#.##"),
                 style=label.style_label_down, color=color.new(color.red, 20),
                 textcolor=color.white, size=getLabelSize(labelSize))

// ══════════════════════════════════════════════════════════════════════════════
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
//                              ALERT CONDITIONS
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
// ══════════════════════════════════════════════════════════════════════════════

// Price enters demand zone alert
alertcondition(alertDemandEntry and inDemandZone and not inDemandZone[1],
              title="Price Enters Demand Zone",
              message="{{ticker}}: Price has entered a demand (support) zone. Potential LONG opportunity.")

// Price enters supply zone alert
alertcondition(alertSupplyEntry and inSupplyZone and not inSupplyZone[1],
              title="Price Enters Supply Zone",
              message="{{ticker}}: Price has entered a supply (resistance) zone. Potential SHORT opportunity.")

// SFP alerts
alertcondition(alertSFP and bullishSFP,
              title="Bullish SFP Detected",
              message="{{ticker}}: Bullish Swing Failure Pattern detected. Price wicked below support but closed above.")

alertcondition(alertSFP and bearishSFP,
              title="Bearish SFP Detected",
              message="{{ticker}}: Bearish Swing Failure Pattern detected. Price wicked above resistance but closed below.")

// EQ break alerts
alertcondition(alertEQBreak and eqBreakBullish,
              title="Bullish EQ Break",
              message="{{ticker}}: Price has broken above the Equilibrium level. Bullish bias confirmed.")

alertcondition(alertEQBreak and eqBreakBearish,
              title="Bearish EQ Break",
              message="{{ticker}}: Price has broken below the Equilibrium level. Bearish bias confirmed.")

// EQH/EQL alerts
alertcondition(alertEQHL and eqhDetected,
              title="Equal Highs (EQH) Formed",
              message="{{ticker}}: Equal Highs detected - Liquidity pool above. Bearish bias (stop hunt potential).")

alertcondition(alertEQHL and eqlDetected,
              title="Equal Lows (EQL) Formed",
              message="{{ticker}}: Equal Lows detected - Liquidity pool below. Bullish bias (stop hunt potential).")

// Breaker/Mitigation alerts
alertcondition(alertBreaker and (bearishMitigation or bullishMitigation),
              title="Mitigation Block Detected",
              message="{{ticker}}: Mitigation block pattern detected. Structure shift in progress.")

// ══════════════════════════════════════════════════════════════════════════════
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
//                           SIGNAL SUMMARY PLOTS
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
// ══════════════════════════════════════════════════════════════════════════════

// Trend bias background
htfBullish = htf1Close > htf1EMA
htfBearish = htf1Close < htf1EMA

// Entry signal confluence
longSignal = inDemandZone and htfBullish and (bullishSFP or bullishMitigation or ltf1Bias == "BULLISH")
shortSignal = inSupplyZone and htfBearish and (bearishSFP or bearishMitigation or ltf1Bias == "BEARISH")

// Plot entry signals
plotshape(longSignal and not longSignal[1], title="Long Entry Signal", location=location.belowbar,
         style=shape.labelup, size=size.normal, color=color.new(color.green, 0), text="LONG", textcolor=color.white)

plotshape(shortSignal and not shortSignal[1], title="Short Entry Signal", location=location.abovebar,
         style=shape.labeldown, size=size.normal, color=color.new(color.red, 0), text="SHORT", textcolor=color.white)

// Alert for confluence signals
alertcondition(longSignal and not longSignal[1],
              title="Long Entry Confluence",
              message="{{ticker}}: LONG ENTRY SIGNAL - Price in demand zone with HTF bullish bias and LTF confirmation.")

alertcondition(shortSignal and not shortSignal[1],
              title="Short Entry Confluence",
              message="{{ticker}}: SHORT ENTRY SIGNAL - Price in supply zone with HTF bearish bias and LTF confirmation.")

// ══════════════════════════════════════════════════════════════════════════════
// END OF SCRIPT
// ══════════════════════════════════════════════════════════════════════════════
